# JuicyChat Dashboard Integration

This document explains how to integrate JuicyChat (the Chat with Data / GENIE-equivalent module) across all dashboards in the Juicer stack.

## Overview

JuicyChat provides natural language querying capabilities for all dashboards, allowing users to ask questions about their data in plain English. The system processes these questions using a combination of:

1. **Text-to-SQL** for structured data queries
2. **RAG (Retrieval Augmented Generation)** for unstructured data
3. **LLM Synthesis** for concise, actionable answers

## Components

The JuicyChat integration consists of three main components:

1. **Frontend Widget** (`juicy-chat-bundle.js`)
   - Floating chat button in dashboard corner
   - Expandable chat interface with message history
   - Support for rich responses (SQL, charts, data tables)

2. **Backend API** (`api/juicer_query_api.py`)
   - REST API endpoint for natural language queries
   - Response formatting with visualization suggestions
   - Dashboard context awareness

3. **Deployment Scripts**
   - `deploy_juicychat.sh` - Adds JuicyChat to all dashboards
   - `run_juicychat_api.sh` - Runs the JuicyChat API
   - `deploy_dashboards_with_chat.sh` - Deploys dashboards to Azure

## Integration Steps

The integration has been automated with the `deploy_juicychat.sh` script, which:

1. Adds the JuicyChat snippet to all dashboard HTML files
2. Creates deployment-ready versions in `deploy` subdirectories
3. Sets up the API endpoint for serving queries
4. Creates scripts for running the API and deploying to Azure

### Manual Integration (if needed)

To manually add JuicyChat to a dashboard:

1. Include the JS bundle:
   ```html
   <script src="juicy-chat-bundle.js"></script>
   ```

2. Add the container div:
   ```html
   <div id="juicy-chat-container"></div>
   ```

3. Configure JuicyChat:
   ```html
   <script>
   window.JuicyChatConfig = {
     apiEndpoint: '/api/juicer/query',
     position: 'bottom-right',
     autoInit: true,
     dashboardContext: {
       type: "dashboard_type",
       dashboard: "dashboard_name"
     }
   };
   </script>
   ```

## Usage

### Running the API

```bash
# Start the API on port 8000 (default)
./run_juicychat_api.sh

# Start the API on a specific port
./run_juicychat_api.sh 9000
```

### Deploying Dashboards

```bash
# Deploy dashboards to Azure Blob Storage
./deploy_dashboards_with_chat.sh
```

### Testing Locally

To test the integration locally:

1. Start the API server:
   ```bash
   ./run_juicychat_api.sh
   ```

2. Serve the dashboard files:
   ```bash
   python -m http.server 8080 --directory dashboards/deploy
   ```

3. Open a browser and navigate to `http://localhost:8080`

## Configuration Options

JuicyChat can be configured with the following options:

```javascript
window.JuicyChatConfig = {
  // API endpoint URL
  apiEndpoint: '/api/juicer/query',
  
  // Position of the chat button (bottom-right, bottom-left, top-right, top-left)
  position: 'bottom-right',
  
  // Automatically initialize on page load
  autoInit: true,
  
  // LLM model to use
  model: 'claude',
  
  // Dashboard-specific context
  dashboardContext: {
    // Dashboard type (retail_advisor, agent_performance, etc.)
    type: "dashboard_type",
    
    // Dashboard identifier
    dashboard: "dashboard_name",
    
    // Current filters (optional)
    filters: {
      timeRange: "last_30_days",
      region: "NCR",
      brand: "Jollibee"
    }
  }
};
```

## Example Queries

JuicyChat supports a wide range of natural language queries:

### Sales Queries
- "Compare sales uplift for Campaign B vs. A in NCR"
- "What was our revenue growth in Q1 2025 compared to Q4 2024?"

### Brand Analysis Queries
- "How many brand mentions did Jollibee get last quarter?"
- "What's the sentiment trend for McDonald's vs KFC?"

### Agent Performance Queries
- "Who are our top performing agents by conversion rate?"
- "Show me agents with declining sentiment scores"

### GenAI Insights Queries
- "What insights have we gathered about customer preferences?"
- "Show me all high-confidence insights about vegetarian menu items"

## Architecture Integration

The JuicyChat component integrates with the existing Juicer system in the following ways:

1. **Medallion Architecture**: Connects to Bronze, Silver, Gold, and Platinum layers
2. **Databricks Integration**: Uses the same Databricks workspace and SQL endpoints
3. **GenAI Insights**: Leverages insights generated by the Insights Generation module
4. **Pulser Agent Integration**: Connects with Claudia, Maya, Kalaw, Echo, and Sunnies agents

## Production Deployment Notes

For production deployment, consider the following:

1. **API Security**: Implement proper authentication for the API
2. **Dashboard Configuration**: Update the apiEndpoint in each dashboard to point to your production API
3. **LLM API Keys**: Configure secure access to LLM API keys (Claude, OpenAI, DeepSeek)
4. **Performance Optimization**: Implement caching and rate limiting for the API
5. **Monitoring**: Add logging and monitoring for the API and dashboards

## Troubleshooting

Common issues and solutions:

1. **Chat button doesn't appear**
   - Verify the `juicy-chat-bundle.js` file is correctly loaded
   - Check for JavaScript errors in the browser console
   - Ensure the `juicy-chat-container` div exists in the HTML

2. **API connection errors**
   - Verify the API is running and accessible
   - Check that the apiEndpoint URL is correctly configured
   - Ensure CORS is properly configured if running on different domains

3. **No responses from LLM**
   - Verify LLM API keys are correctly configured
   - Check API logs for errors or timeouts
   - Ensure the LLM model specified is available

## Additional Resources

- [GENIE Integration Documentation](README_GENIE_INTEGRATION.md)
- [Juicer Insights Documentation](GENAI_INSIGHTS_INTEGRATION.md)
- [Databricks Integration Guide](AZURE_DEPLOYMENT_GUIDE.md)